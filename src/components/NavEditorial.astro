---
// NavEditorial.astro - Bold editorial navigation
import logo from '../assets/images/getu-logo.png';

const navigation = [
  { name: 'Startseite', href: '/' },
  { name: 'Ãœber uns', href: '/ueber-uns' },
  {
    name: 'Projekte',
    href: '/projekte',
    dropdown: [
      { name: 'Youth with Perspective', href: '/projekte/youth' },
      { name: 'Mentoring', href: '/projekte/mentoring' },
      { name: 'Weihnachtsaktion', href: '/projekte/weihnachtsaktion' },
      { name: 'Stammtisch', href: '/projekte/stammtisch' },
    ],
  },
  { name: 'Kontakt', href: '/kontakt' },
];

const currentPath = Astro.url.pathname;
---

<header
  id="main-header"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-500"
>
  <!-- Progress bar -->
  <div
    id="scroll-progress"
    class="absolute bottom-0 left-0 h-[2px] bg-[var(--color-secondary)] transition-transform duration-100"
    style="transform: scaleX(0); transform-origin: left;"
  ></div>

  <div class="nav-container relative px-6 md:px-12 lg:px-20">
    <div class="flex items-center justify-between h-20 lg:h-24">

      <!-- Logo -->
      <a
        href="/"
        class="logo-link relative z-10 flex items-center gap-3 group"
      >
        <img
          src={logo.src}
          alt="GeTu"
          class="h-12 lg:h-14 w-auto transition-transform duration-300 group-hover:scale-105"
        />
        <span class="logo-text hidden lg:block font-display text-lg font-medium tracking-tight text-white transition-colors duration-300">
          GeTu Prospects
        </span>
      </a>

      <!-- Desktop Navigation - Center -->
      <nav class="hidden lg:flex items-center gap-2">
        {navigation.map((item) => {
          const isActive = currentPath === item.href ||
                          (item.href !== '/' && currentPath.startsWith(item.href));

          return (
            <div class="nav-item relative group">
              <a
                href={item.href}
                class:list={[
                  "nav-link relative block px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] transition-all duration-300",
                  "text-white/70 hover:text-white",
                  { "!text-[var(--color-secondary)]": isActive }
                ]}
              >
                <span class="relative z-10 flex items-center gap-2">
                  {item.name}
                  {item.dropdown && (
                    <svg class="w-3 h-3 transition-transform duration-300 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  )}
                </span>

                <!-- Animated underline -->
                <span
                  class:list={[
                    "absolute bottom-0 left-6 right-6 h-[2px] bg-[var(--color-secondary)] transition-transform duration-300 origin-left",
                    isActive ? "scale-x-100" : "scale-x-0 group-hover:scale-x-100"
                  ]}
                />
              </a>

              <!-- Dropdown -->
              {item.dropdown && (
                <div class="dropdown-menu absolute top-full left-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                  <div class="bg-white/95 backdrop-blur-md shadow-2xl border-t-2 border-[var(--color-secondary)] min-w-[240px]">
                    {item.dropdown.map((dropItem, index) => (
                      <a
                        href={dropItem.href}
                        class="dropdown-item block px-6 py-4 text-sm font-medium text-[var(--color-primary)] hover:bg-[var(--color-secondary)]/5 hover:text-[var(--color-secondary)] transition-all duration-200 border-b border-gray-100 last:border-b-0"
                        style={`transition-delay: ${index * 50}ms`}
                      >
                        <span class="flex items-center justify-between">
                          {dropItem.name}
                          <svg class="w-4 h-4 opacity-0 -translate-x-2 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                          </svg>
                        </span>
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </nav>

      <!-- CTA Button - Desktop -->
      <div class="hidden lg:block">
        <a
          href="/kontakt"
          class="cta-button relative overflow-hidden inline-flex items-center gap-2 px-8 py-4 bg-[var(--color-secondary)] text-white text-sm font-semibold uppercase tracking-wider transition-all duration-300 hover:bg-[var(--color-primary)] group"
        >
          <span class="relative z-10">Mitmachen</span>
          <svg class="relative z-10 w-4 h-4 transform transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      </div>

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-toggle"
        class="lg:hidden relative z-50 w-12 h-12 flex items-center justify-center group"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <div class="hamburger-lines relative w-6 h-5 flex flex-col justify-between">
          <span class="hamburger-line block h-[2px] w-full bg-white transition-all duration-300 origin-left"></span>
          <span class="hamburger-line block h-[2px] w-full bg-white transition-all duration-300"></span>
          <span class="hamburger-line block h-[2px] w-full bg-white transition-all duration-300 origin-left"></span>
        </div>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-40 pointer-events-none"
  aria-hidden="true"
>
  <!-- Backdrop -->
  <div class="mobile-backdrop absolute inset-0 bg-[var(--color-primary)] opacity-0 transition-opacity duration-500"></div>

  <!-- Menu Content -->
  <div class="mobile-content absolute inset-0 flex flex-col pt-24 pb-12 px-8 opacity-0 translate-x-full transition-all duration-500">

    <!-- Navigation Links -->
    <nav class="flex-1 flex flex-col justify-center">
      <ul class="space-y-2">
        {navigation.map((item, index) => {
          const isActive = currentPath === item.href;

          return (
            <li
              class="mobile-nav-item opacity-0 translate-x-8"
              style={`transition-delay: ${150 + index * 75}ms`}
            >
              {item.dropdown ? (
                <div class="mobile-dropdown">
                  <button
                    class="mobile-dropdown-toggle w-full flex items-center justify-between py-4 border-b border-white/10"
                    data-dropdown
                  >
                    <span class:list={[
                      "font-display text-3xl md:text-4xl font-medium transition-colors duration-300",
                      isActive ? "text-[var(--color-secondary)]" : "text-white hover:text-[var(--color-secondary)]"
                    ]}>
                      {item.name}
                    </span>
                    <svg class="mobile-dropdown-icon w-6 h-6 text-[var(--color-secondary)] transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </button>
                  <ul class="mobile-dropdown-content hidden pl-4 pt-2 pb-4 space-y-3 border-b border-white/10">
                    {item.dropdown.map((dropItem) => (
                      <li>
                        <a
                          href={dropItem.href}
                          class="block text-xl text-white/70 hover:text-[var(--color-secondary)] transition-colors duration-200"
                        >
                          {dropItem.name}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a
                  href={item.href}
                  class="block py-4 border-b border-white/10"
                >
                  <span class:list={[
                    "font-display text-3xl md:text-4xl font-medium transition-colors duration-300",
                    isActive ? "text-[var(--color-secondary)]" : "text-white hover:text-[var(--color-secondary)]"
                  ]}>
                    {item.name}
                  </span>
                </a>
              )}
            </li>
          );
        })}
      </ul>
    </nav>

    <!-- Mobile CTA -->
    <div class="mobile-cta opacity-0 translate-y-4 transition-all duration-500" style="transition-delay: 400ms">
      <a
        href="/kontakt"
        class="block w-full py-5 bg-[var(--color-secondary)] text-white text-center text-lg font-semibold uppercase tracking-wider transition-all duration-300 hover:bg-white hover:text-[var(--color-primary)]"
      >
        Jetzt Mitmachen
      </a>

      <!-- Contact info -->
      <div class="mt-8 pt-8 border-t border-white/10">
        <p class="text-white/50 text-sm uppercase tracking-wider mb-3">Kontakt</p>
        <a href="mailto:info@getu-prospects.de" class="block text-white/80 hover:text-[var(--color-secondary)] transition-colors">
          info@getu-prospects.de
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  /* Initial transparent state for heroes */
  #main-header {
    background: linear-gradient(
      to bottom,
      rgba(26, 26, 26, 0.4) 0%,
      rgba(26, 26, 26, 0) 100%
    );
  }

  /* Scrolled state */
  #main-header.scrolled {
    background: rgba(26, 26, 26, 0.98);
    backdrop-filter: blur(12px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.15);
  }

  #main-header.scrolled .logo-text {
    color: white;
  }

  #main-header.scrolled .nav-link {
    color: rgba(255, 255, 255, 0.85);
  }

  #main-header.scrolled .nav-link:hover {
    color: white;
  }

  /* Dropdown hover arrow animation */
  .dropdown-item:hover svg {
    opacity: 1;
    transform: translateX(0);
  }

  /* Mobile menu open states */
  .mobile-menu-open {
    overflow: hidden;
  }

  #mobile-menu.active {
    pointer-events: auto;
  }

  #mobile-menu.active .mobile-backdrop {
    opacity: 1;
  }

  #mobile-menu.active .mobile-content {
    opacity: 1;
    transform: translateX(0);
  }

  #mobile-menu.active .mobile-nav-item {
    opacity: 1;
    transform: translateX(0);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  #mobile-menu.active .mobile-cta {
    opacity: 1;
    transform: translateY(0);
  }

  /* Hamburger animation */
  #mobile-toggle.active .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translateY(6px);
  }

  #mobile-toggle.active .hamburger-line:nth-child(2) {
    opacity: 0;
    transform: scaleX(0);
  }

  #mobile-toggle.active .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translateY(-6px);
  }

  /* Mobile dropdown animation */
  .mobile-dropdown-toggle.active .mobile-dropdown-icon {
    transform: rotate(180deg);
  }

  .mobile-dropdown-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .mobile-dropdown-content.active {
    display: block;
    max-height: 200px;
  }

  /* Ensure nav works on light backgrounds too */
  #main-header.light-mode {
    background: rgba(255, 252, 247, 0.95);
    backdrop-filter: blur(12px);
  }

  #main-header.light-mode .logo-text,
  #main-header.light-mode .nav-link {
    color: var(--color-primary);
  }

  #main-header.light-mode .hamburger-line {
    background: var(--color-primary);
  }

  #main-header.light-mode .cta-button {
    background: var(--color-primary);
  }

  #main-header.light-mode .cta-button:hover {
    background: var(--color-secondary);
  }
</style>

<script>
  function initNavigation() {
    const header = document.getElementById('main-header');
    const mobileToggle = document.getElementById('mobile-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const scrollProgress = document.getElementById('scroll-progress');
    const dropdownToggles = document.querySelectorAll('[data-dropdown]');

    if (!header || !mobileToggle || !mobileMenu) return;

    // Scroll handling
    let lastScroll = 0;
    let ticking = false;

    function updateHeader() {
      const scrollY = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = scrollY / docHeight;

      // Update progress bar
      if (scrollProgress) {
        scrollProgress.style.transform = `scaleX(${scrollPercent})`;
      }

      // Add/remove scrolled class
      if (scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }

      // Hide/show on scroll direction (optional, disabled for now)
      // if (scrollY > lastScroll && scrollY > 200) {
      //   header.style.transform = 'translateY(-100%)';
      // } else {
      //   header.style.transform = 'translateY(0)';
      // }

      lastScroll = scrollY;
      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(updateHeader);
        ticking = true;
      }
    });

    // Initial check
    updateHeader();

    // Mobile menu toggle
    mobileToggle.addEventListener('click', () => {
      const isOpen = mobileMenu.classList.contains('active');

      if (isOpen) {
        mobileMenu.classList.remove('active');
        mobileToggle.classList.remove('active');
        mobileToggle.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('mobile-menu-open');
      } else {
        mobileMenu.classList.add('active');
        mobileToggle.classList.add('active');
        mobileToggle.setAttribute('aria-expanded', 'true');
        document.body.classList.add('mobile-menu-open');
      }
    });

    // Close mobile menu on link click
    mobileMenu.querySelectorAll('a:not([data-dropdown])').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        mobileToggle.classList.remove('active');
        document.body.classList.remove('mobile-menu-open');
      });
    });

    // Mobile dropdown toggles
    dropdownToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const content = toggle.nextElementSibling;
        const isActive = toggle.classList.contains('active');

        // Close all other dropdowns
        dropdownToggles.forEach(other => {
          if (other !== toggle) {
            other.classList.remove('active');
            other.nextElementSibling?.classList.remove('active');
          }
        });

        toggle.classList.toggle('active');
        content?.classList.toggle('active');
      });
    });

    // Close mobile menu on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
        mobileMenu.classList.remove('active');
        mobileToggle.classList.remove('active');
        document.body.classList.remove('mobile-menu-open');
      }
    });

    // Check if page needs light mode nav (for pages without dark heroes)
    const hero = document.querySelector('[data-hero-dark]');

    if (!hero && window.scrollY < 50) {
      // No dark hero, check background color
      const firstSection = document.querySelector('main > section:first-child');

      if (firstSection) {
        const bgColor = window.getComputedStyle(firstSection).backgroundColor;
        const rgb = bgColor.match(/\d+/g);

        if (rgb) {
          const brightness = (parseInt(rgb[0]) * 299 + parseInt(rgb[1]) * 587 + parseInt(rgb[2]) * 114) / 1000;

          if (brightness > 150) {
            header.classList.add('light-mode');
          }
        }
      }
    }
  }

  // Init on load and Astro navigation
  initNavigation();
  document.addEventListener('astro:page-load', initNavigation);
</script>
